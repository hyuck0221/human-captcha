# 📜 Project: Human-to-Human CAPTCHA System (H2H-CAPTCHA)

이 문서는 **"사람이 직접 검증하는 실시간 캡차 시스템"** 구현을 위한 가이드라인입니다. 매크로가 흉내 낼 수 없는 실시간성 상호작용과 집단지성을 이용한 보안 솔루션을 구축합니다.

---

## 1. 프로젝트 목표 및 철학
- **핵심 가치**: "기계는 판단할 수 없으나, 사람은 직관적으로 판단할 수 있는 행동"을 검증 도구로 활용.
- **주요 전략**: 요청자(Client)와 처리자(Validator)를 1:1 실시간 매칭하여 상호작용을 중계함.
- **경험 요소**: 지루한 문자 입력 대신 가위바위보, 그림 그리기 등 재미있는 요소를 도입.

---

## 2. 요구사항 명세 (Requirements)

### A. 매칭 및 대기열 시스템
- **우선순위**: 캡차 검사를 요청하는 사람(Client)이 대기열에 먼저 쌓이고, 처리자(Validator)가 들어오는 즉시 매칭함.
- **익명성 보장**: 서로의 개인정보나 ID는 절대 노출되지 않으며, 세션 기반의 임시 식별자만 사용함.
- **재매칭 방지**: 검증 실패 시 다시 대기열로 돌아가지만, 직전에 매칭되었던 처리자와는 다시 만나지 않도록 매칭 이력(Blacklist)을 메모리에 관리함.
- **최종 실패**: 총 3번의 검증 실패 시 최종 탈락 처리하며, 이전 페이지로 강제 리다이렉트함.

### B. 실시간 스트리밍 및 동기화
- **마우스 트래킹**: 요청자의 마우스 포인터 좌표(X, Y)를 실시간으로 캡처하여 처리자 화면의 가상 포인터(Ghost Pointer)로 렌더링함.
- **전송 주기**: 부드러운 움직임을 위해 최소 50ms~100ms 주기로 데이터 전송.
- **기술 스택**: Spring Boot WebSocket (STOMP) + Kotlin Coroutines 활용.

### C. 인터랙티브 챌린지 (미션)
매칭 성공 시 시스템은 다음 동작들을 수행할 수 있는 버튼들을 validator에게 제공:
1. **가위바위보**: 실시간으로 서로 선택을 주고받아 사람다운 심리적 반응 시간 확인.
2. **주제어 드로잉**: 처리자가 "별", "자동차" 등 주제를 주면 요청자가 캔버스에 그림을 그림.
3. **실시간 채팅**: 처리자의 돌발 질문에 요청자가 자연어로 응답.

---

## 3. 백엔드 설계 가이드 (Kotlin + Spring Boot)

- **데이터 관리**: DB 없이 **인메모리(ConcurrentHashMap)** 기반으로 관리.
- **메모리 누수 방지**:
    - 세션 타임아웃(예: 2분) 설정.
    - 연결 종료(Disconnect) 이벤트 발생 시 즉시 대기열 및 세션 메모리에서 제거.
    - `Scheduled` 작업을 통해 주기적으로 죽은 세션 청소.
- **주요 컴포넌트**:
    - `MatchingManager`: 대기열 및 매칭 로직 (Thread-safe).
    - `SessionRegistry`: 활성화된 1:1 세션 상태 관리.
    - `CaptchaWebSocketHandler`: 메시지 라우팅 (요청자 -> 처리자).

---

## 4. 프론트엔드 설계 가이드 (React/Vue/Vanilla JS)

- **모듈화**: 다른 프로젝트에 쉽게 이식할 수 있도록 독립적인 모달(Modal) 혹은 컴포넌트 형태로 설계.
- **캔버스 동기화**: `HTML5 Canvas`를 활용해 요청자의 드로잉과 마우스 궤적을 실시간 렌더링.
- **상태 관리**:
    - `MATCHING_WAITING`: 대기 중
    - `IN_PROGRESS`: 검증 진행 중 (상대방 마우스 보임)
    - `SUCCESS/FAIL`: 결과 안내

---

## 5. AI 지시용 단계별 태스크 (Implementation Steps)

1. **Step 1**: Kotlin 기반 Spring Boot 프로젝트 설정 및 STOMP WebSocket 인프라를 구축해줘.
2. **Step 2**: `Client`와 `Validator`를 1:1로 매칭하고, 매칭 이력을 추적하여 재매칭을 방지하는 `MatchingService`를 작성해줘. (인메모리 방식)
3. **Step 3**: 요청자의 마우스 좌표를 서버를 통해 처리자에게 실시간 스트리밍하고, 처리자 화면에 이를 시각화하는 프론트엔드 코드를 작성해줘.
4. **Step 4**: "가위바위보"와 "그림 그리기" 미션 로직을 추가하고, 처리자가 [승인/거절] 버튼을 누를 때의 워크플로우를 구현해줘.
5. **Step 5**: 3회 실패 시 처리 로직과 세션 타임아웃에 따른 메모리 정리 로직을 완성해줘.

---

## 6. 보안 및 예외 처리
- 처리자가 악의적으로 [거절]만 누를 경우를 대비해 처리자의 신뢰도 점수(별도 구현 가능성) 고려.
- 클라이언트 쪽에서 전송하는 마우스 좌표 데이터의 위변조 방지를 위한 최소한의 검증 로직 추가.